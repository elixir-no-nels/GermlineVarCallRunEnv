## Note: These instructions are currently being updated 

# Official development location for the Elixir Germline Variant Calling pipeline

## Genering instructions for running/testing outside TSD  

### Setup and preparations

The RunDockerWorkflow-TSD.py script help you to run the workflow in a Docker container with a minimal set of options.  
The simplest way to get started is to clone this repository, install Docker, start a container with correct parameters and then you're good to go!  

To install Docker you can follow the appropriate instructions on Dockers website for instructions: https://docs.docker.com/engine/installation/

To install the latest rbFlow based Docker image, run 
```
sudo docker pull kjellptrsn/germlinevarcalldocker
```
(These instructions assume you are running docker through sudo, if you are a member of the docker group on your system, you setup may allow you to skip the sudo command).


Before we run the docker image, we need to configure the startFromDocker.sh script.  

Scroll down and change the file paths at "# Paths" to point to your reference files and the data folder (= the folder you checked out this repo to. Having data in a separate location to be tested and developed further next). 

The workflow is divided in two parts, the pre processing and germline calling discibed in two separate scripts called preprocessing.yaml and germline_varcall.yaml.

### Run the workflow

As long as you run the RunDockerWorkflow-TSD.py script from the "run" folder you should be ready to test the pipeline with the test data that is included in the "Samples" folder. Be adviced that the pipeline will crash on the final step in the germline_varcall.yaml workflow called "VariantRecalibration" due to too few read in the test fastq files (the variant quality recalibration steps will fail). As long as you have a complete set of fastq files the pipeline will finish successfully though.  
To start the pipeline, go to the terminal, change your working directory to the "run" directory and run 
```
RunDockerWorkflow-TSD.py -d docker_image -i /absolute/path/to/inputs_dir/ -o /absolute/path/to/outputs_dir/ -r /absolute/path/to/references_dir/ -y /absolute/path/to/workflow_script.yaml 

```

To run the complete workflow you have to run the preprocessing step by providing  preprocessing.yaml to the -y option, and then the calling by providing the germline_varcall.yaml file.


### Cleaning the folder between runs  
If you run the clean.sh script, you will delete everything that gets created during an analysis.



## Instructions for Deployment and Running pipeline inside TSD

### Deployment of docker image in TSD Core Facility Docker VM

### Deployment of Workflow definitions and scripts needed

### How to run the workflow

```
sudo RunDockerWorkflow-TSD.py -i /absolute/path/to/inputs_dir/ -o /absolute/path/to/outputs_dir/ -r /absolute/path/to/references_dir/ -y /absolute/path/to/workflow_script.yaml
```

All directories and files have to be in your project area.

### Cleaning the data folder between runs
```
rm -r outputs_dir/*
```


### Restarting a run after an error

If you get an error, you can check the log file generated by the workflow located in the "***outputs_dir/Logs***" to find the failing step.
You can acces to logs from this step in the "***outputs_dir/step_dir/ToolName_stderr-Date-Time.log***"
After you have fixed the problem you can restart the workflow. The engine doesn't restart steps detected as succesfully passed, if you want restart a specific step you can remove "***outputs_dir/FinishedSteps/step_name.passed***"

### Logs

Usefull tips

Get all command exectuted by the workflow
```
grep EXECUTE outputs_dir/Logs/WorkFlowRun_Date_Time.log 
```

Get all running time for each steps
```
grep END: outputs_dir/Logs/WorkFlowRun_Date_Time.log 
```







